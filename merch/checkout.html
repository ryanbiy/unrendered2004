<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | biy</title>
    <meta name="description" content="Complete your order">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo-group">
                <a href="index.html" class="logo">biy</a>
                <span class="categories-toggle" onclick="toggleCategories()"
                    style="font-family: 'Press Start 2P', monospace; font-size: 0.55rem; color: #00ffff; cursor: pointer; display: none;">menu</span>
            </div>
            <nav>
                <a href="tees.html">Tees</a>
                <a href="hoodies.html">Hoodies</a>
                <a href="pants.html">Pants</a>
                <a href="footwear.html">Footwear</a>
                <a href="contact.html">Contact</a>
            </nav>
            <div class="mobile-nav-actions" style="display: flex; align-items: center; gap: 16px;">
                <span class="cart-icon" onclick="toggleCart()"><i class="fas fa-shopping-cart"></i><span
                        id="cart-count">0</span></span>
                <div class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            </div>
        </div>
    </header>

    <main>
        <section class="section-header">
            <h1>Checkout</h1>
            <p>Complete your order</p>
        </section>

        <div class="checkout-container">
            <div class="checkout-form pixel-border">
                <h2>Shipping Information</h2>
                <form id="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone">
                    </div>

                    <div class="form-group">
                        <label for="address">Street Address *</label>
                        <input type="text" id="address" name="address" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code *</label>
                            <input type="text" id="zip" name="zip" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="AE">UAE</option>
                            <option value="SA">Saudi Arabia</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <h2 style="margin-top: 32px;">Payment Method</h2>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="payment" value="mpesa" checked>
                            <span>üì± M-Pesa</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment" value="cod">
                            <span>üíµ Cash on Delivery</span>
                        </label>
                    </div>

                    <!-- M-Pesa Phone Number (shown when M-Pesa is selected) -->
                    <div id="mpesa-phone-group" class="form-group" style="margin-top: 16px;">
                        <label for="mpesa-phone">M-Pesa Phone Number *</label>
                        <input type="tel" id="mpesa-phone" name="mpesa-phone" placeholder="254712345678"
                            pattern="[0-9]{12}">
                        <small style="display: block; margin-top: 4px; opacity: 0.7;">Format: 254XXXXXXXXX (12
                            digits)</small>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 24px;">
                        Place Order
                    </button>
                </form>
            </div>

            <div class="order-summary pixel-border">
                <h2>Order Summary</h2>
                <div id="checkout-items"></div>
                <div class="summary-totals">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span id="shipping">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="order-total">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Confirmation Modal -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content pixel-border">
                <h2>‚úì Order Confirmed!</h2>
                <p>Thank you for your order.</p>
                <p>A confirmation email has been sent to <strong id="confirm-email"></strong></p>
                <p>Order Number: <strong id="order-number"></strong></p>
                <a href="index.html" class="btn" style="margin-top: 24px;">Continue Shopping</a>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Shop</h4>
                <a href="tees.html">Tees</a>
                <a href="hoodies.html">Hoodies</a>
                <a href="pants.html">Pants</a>
                <a href="footwear.html">Footwear</a>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="https://instagram.com/biyclothing" target="_blank"><i class="fab fa-instagram"></i></a>
                    <a href="https://twitter.com/biyclothing" target="_blank"><i class="fab fa-twitter"></i></a>
                    <a href="https://tiktok.com/@biyclothing" target="_blank"><i class="fab fa-tiktok"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Info</h4>
                <a href="contact.html">Contact</a>
                <a href="login.html">Admin</a>
            </div>
        </div>
        <div class="footer-bottom">¬© 2024 biy</div>
    </footer>

    <!-- Sidebar Navigation -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-nav">
            <a href="index.html" onclick="toggleSidebar()">Home</a>
            <a href="tees.html" onclick="toggleSidebar()">Tees</a>
            <a href="hoodies.html" onclick="toggleSidebar()">Outerwear</a>
            <a href="pants.html" onclick="toggleSidebar()">Jeans</a>
            <a href="footwear.html" onclick="toggleSidebar()">Footwear</a>
            <a href="accessories.html" onclick="toggleSidebar()">Accessories</a>
            <a href="contact.html" onclick="toggleSidebar()">Contact</a>
            <a href="login.html" onclick="toggleSidebar()">Admin</a>
        </div>
    </div>

    <script src="access.js"></script>
    <!-- Categories Pop-up -->
    <div class="sidebar-overlay" id="category-overlay" onclick="toggleCategories()"></div>
    <div class="category-popup" id="category-popup">
        <h2
            style="font-family: 'Press Start 2P', monospace; font-size: 0.8rem; margin-bottom: 24px; text-align: center;">
            Categories</h2>
        <div class="category-grid">
            <a href="tees.html" class="category-item">Tees</a>
            <a href="hoodies.html" class="category-item">Outerwear</a>
            <a href="pants.html" class="category-item">Jeans</a>
            <a href="footwear.html" class="category-item">Footwear</a>
            <a href="accessories.html" class="category-item">Accessories</a>
            <a href="contact.html" class="category-item">Contact</a>
        </div>
    </div>

    <script src="cart.js"></script>
    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }

        function toggleCategories() {
            document.getElementById('category-popup').classList.toggle('open');
            document.getElementById('category-overlay').classList.toggle('open');
        }
        // Payment method toggle
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const mpesaGroup = document.getElementById('mpesa-phone-group');
                if (this.value === 'mpesa') {
                    mpesaGroup.style.display = 'block';
                    document.getElementById('mpesa-phone').required = true;
                } else {
                    mpesaGroup.style.display = 'none';
                    document.getElementById('mpesa-phone').required = false;
                }
            });
        });

        // Render checkout items
        function renderCheckoutItems() {
            const container = document.getElementById('checkout-items');
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty</p>';
                return;
            }

            container.innerHTML = cart.map(item => `
        <div class="checkout-item">
          <img src="${item.image}" alt="${item.name}">
          <div class="checkout-item-info">
            <h4>${item.name}</h4>
            <p>Size: ${item.size} | Qty: ${item.quantity}</p>
          </div>
          <span>$${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal > 100 ? 0 : 15;
            const total = subtotal + shipping;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAum8_apfBgC8xZ0fpCLJK8sC0nSpp4O6g",
            authDomain: "biy-clothing-store-36dd8.firebaseapp.com",
            databaseURL: "https://biy-clothing-store-36dd8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "biy-clothing-store-36dd8",
            storageBucket: "biy-clothing-store-36dd8.firebasestorage.app",
            messagingSenderId: "117150750056",
            appId: "1:117150750056:web:82e51312fe2ca3cfa7f2dd"
        };

        // Initialize Firebase
        let db = null;
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        }

        // Generate order number
        function generateOrderNumber() {
            return 'STW-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        // Handle form submission
        document.getElementById('checkout-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const formData = new FormData(this);
                const orderNumber = generateOrderNumber();
                const email = formData.get('email');
                const paymentMethod = formData.get('payment');

                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = subtotal > 100 ? 0 : 15;
                const total = subtotal + shipping;

                // Store order data
                const orderData = {
                    orderNumber,
                    date: new Date().toISOString(),
                    customer: {
                        name: `${formData.get('firstName')} ${formData.get('lastName')}`,
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: email,
                        phone: formData.get('phone') || formData.get('mpesa-phone'),
                        address: formData.get('address'),
                        city: formData.get('city'),
                        postalCode: formData.get('zip'),
                        country: formData.get('country')
                    },
                    items: cart,
                    total,
                    paymentMethod: paymentMethod,
                    paymentStatus: 'pending',
                    status: 'pending',
                    mpesaReceiptNumber: '',
                    mpesaTransactionId: ''
                };

                // Save to Firebase
                let orderId;
                if (db) {
                    const orderRef = await db.ref('orders').push(orderData);
                    orderId = orderRef.key;
                } else {
                    // Fallback to localStorage
                    const orders = JSON.parse(localStorage.getItem('orders')) || [];
                    orders.push(orderData);
                    localStorage.setItem('orders', JSON.stringify(orders));
                }

                // If M-Pesa payment, initiate STK Push
                if (paymentMethod === 'mpesa') {
                    submitBtn.textContent = 'Initiating M-Pesa...';

                    const mpesaPhone = formData.get('mpesa-phone');

                    try {
                        const response = await fetch('/.netlify/functions/mpesa-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                phoneNumber: mpesaPhone,
                                amount: total,
                                orderId: orderNumber,
                                accountReference: orderNumber
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('‚úÖ STK Push sent! Please check your phone and enter your M-Pesa PIN.');
                            submitBtn.textContent = 'Waiting for payment...';

                            // Poll for payment status (simplified - in production use webhooks)
                            setTimeout(() => {
                                showOrderConfirmation(email, orderNumber);
                            }, 5000);
                        } else {
                            throw new Error(result.error || 'M-Pesa payment failed');
                        }
                    } catch (mpesaError) {
                        console.error('M-Pesa error:', mpesaError);
                        alert('‚ùå M-Pesa payment failed: ' + mpesaError.message + '\n\nOrder saved as Cash on Delivery.');
                        showOrderConfirmation(email, orderNumber);
                    }
                } else {
                    // Cash on Delivery - show confirmation immediately
                    showOrderConfirmation(email, orderNumber);
                }

            } catch (error) {
                console.error('Order error:', error);
                alert('Failed to place order: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });

        function showOrderConfirmation(email, orderNumber) {
            // Show confirmation
            document.getElementById('confirm-email').textContent = email;
            document.getElementById('order-number').textContent = orderNumber;
            document.getElementById('confirmation-modal').classList.add('show');

            // Clear cart
            localStorage.removeItem('cart');
            updateCartCount();
        }

        // Initialize
        renderCheckoutItems();
    </script>
</body>

</html>