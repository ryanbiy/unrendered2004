<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | biy</title>
    <meta name="description" content="Business dashboard">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .admin-tabs::-webkit-scrollbar {
            display: none;
        }

        .admin-tab {
            flex: 0 0 auto;
            padding: 12px 20px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.55rem;
            background: #f5f5f5;
            border: 2px solid var(--primary-color);
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .admin-tab.active {
            background: var(--primary-color);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert-box {
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-warning {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .alert-success {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .alert-danger {
            background: #ffebee;
            border-color: #f44336;
        }

        .product-form {
            display: grid;
            gap: 16px;
            max-width: 600px;
        }

        .product-form input,
        .product-form select,
        .product-form textarea {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .quick-action-card {
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .quick-action-card:hover {
            transform: translateY(-4px);
        }

        .quick-action-card h3 {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            margin-bottom: 8px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo-group">
                <a href="index.html" class="logo">biy</a>
                <span class="categories-toggle" onclick="toggleCategories()"
                    style="font-family: 'Press Start 2P', monospace; font-size: 0.55rem; color: #00ffff; cursor: pointer; display: none;">menu</span>
            </div>
            <nav>
                <a href="admin.html">Dashboard</a>
                <a href="index.html">View Shop</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
            <div class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        </div>
    </header>

    <main>
        <section class="section-header">
            <h1>Admin Dashboard</h1>
            <p>Manage your shop</p>
        </section>

        <!-- Alerts -->
        <div id="alerts"></div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-card pixel-border" onclick="showTab('orders')">
                <h3>üì¶ Orders</h3>
                <p id="quick-orders">0 pending</p>
            </div>
            <div class="quick-action-card pixel-border" onclick="showTab('products')">
                <h3>üè∑Ô∏è Products</h3>
                <p id="quick-products">0 items</p>
            </div>
            <div class="quick-action-card pixel-border" onclick="showTab('analytics')">
                <h3>üìä Analytics</h3>
                <p>View stats</p>
            </div>
            <div class="quick-action-card pixel-border" onclick="showTab('settings')">
                <h3>‚öôÔ∏è Settings</h3>
                <p>Shop config</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="showTab('overview')">Overview</button>
            <button class="admin-tab" onclick="showTab('orders')">Orders</button>
            <button class="admin-tab" onclick="showTab('products')">Products</button>
            <button class="admin-tab" onclick="showTab('customers')">Customers</button>
            <button class="admin-tab" onclick="showTab('analytics')">Analytics</button>
            <button class="admin-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active">
            <div class="admin-stats">
                <div class="stat-card pixel-border">
                    <h3 id="total-orders">0</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card pixel-border">
                    <h3 id="pending-orders">0</h3>
                    <p>Pending</p>
                </div>
                <div class="stat-card pixel-border">
                    <h3 id="total-revenue">$0</h3>
                    <p>Revenue</p>
                </div>
                <div class="stat-card pixel-border">
                    <h3 id="total-customers">0</h3>
                    <p>Customers</p>
                </div>
            </div>

            <!-- Shop Status Control -->
            <div class="shop-control pixel-border" style="padding: 24px; margin: 32px 0;">
                <h2 style="font-family: 'Press Start 2P', monospace; font-size: 0.9rem; margin-bottom: 16px;">Shop
                    Access Control</h2>
                <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                    <div>
                        <strong>Shop Status:</strong>
                        <span id="shop-status"></span>
                    </div>
                    <button id="toggle-shop" class="btn" onclick="toggleShopStatus()">Toggle Status</button>
                </div>
                <p style="margin-top: 12px; font-size: 0.85rem; opacity: 0.7;">
                    When closed, buyers see "Sold Out" page. You can always access as admin.
                </p>
            </div>

            <!-- Low Stock Alerts -->
            <div id="low-stock-alerts" style="margin-top: 24px;"></div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tab-orders" class="tab-content">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                <h2 style="font-family: 'Press Start 2P', monospace; font-size: 1rem;">Orders</h2>
                <button class="btn" onclick="exportOrders()">üì• Export CSV</button>
            </div>
            <div class="orders-table-wrapper pixel-border">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-body"></tbody>
                </table>
                <p id="no-orders" style="text-align: center; padding: 40px; display: none;">No orders yet</p>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="tab-products" class="tab-content">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                <h2 style="font-family: 'Press Start 2P', monospace; font-size: 1rem;">Products</h2>
                <button class="btn" onclick="showAddProduct()">+ Add Product</button>
            </div>

            <!-- Add Product Form (hidden by default) -->
            <div id="add-product-form" class="pixel-border" style="padding: 24px; margin-bottom: 24px; display: none;">
                <h3 style="font-family: 'Press Start 2P', monospace; font-size: 0.8rem; margin-bottom: 16px;">Add New
                    Product</h3>
                <div class="product-form">
                    <input type="text" id="new-name" placeholder="Product Name" required>
                    <input type="text" id="new-brand" placeholder="Brand" required>
                    <select id="new-category">
                        <option value="tees">Tees</option>
                        <option value="outerwear">Outerwear</option>
                        <option value="jeans">Jeans</option>
                        <option value="footwear">Footwear</option>
                        <option value="accessories">Accessories</option>
                    </select>
                    <input type="number" id="new-price" placeholder="Price" step="0.01" required>
                    <input type="number" id="new-stock" placeholder="Stock Quantity" required>
                    <input type="text" id="new-sizes" placeholder="Sizes (comma separated, e.g. S,M,L,XL)">
                    <input type="text" id="new-image" placeholder="Image URL">
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
                        <button class="btn" onclick="hideAddProduct()">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="orders-table-wrapper pixel-border">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product</th>
                            <th>Brand</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stock-body"></tbody>
                </table>
            </div>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="tab-customers" class="tab-content">
            <h2 style="font-family: 'Press Start 2P', monospace; font-size: 1rem; margin-bottom: 16px;">Customers</h2>
            <div class="orders-table-wrapper pixel-border">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Orders</th>
                            <th>Total Spent</th>
                            <th>Last Order</th>
                        </tr>
                    </thead>
                    <tbody id="customers-body"></tbody>
                </table>
                <p id="no-customers" style="text-align: center; padding: 40px; display: none;">No customers yet</p>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="tab-analytics" class="tab-content">
            <h2 style="font-family: 'Press Start 2P', monospace; font-size: 1rem; margin-bottom: 24px;">Analytics</h2>

            <div class="admin-stats">
                <div class="stat-card pixel-border">
                    <h3 id="today-orders">0</h3>
                    <p>Today's Orders</p>
                </div>
                <div class="stat-card pixel-border">
                    <i class="fas fa-wallet"
                        style="font-size: 1.5rem; color: var(--neon-cyan); margin-bottom: 12px;"></i>
                    <h3>Total Revenue</h3>
                    <p id="total-revenue">$0.00</p>
                </div>
                <div class="stat-card pixel-border">
                    <i class="fas fa-shopping-bag"
                        style="font-size: 1.5rem; color: var(--neon-pink); margin-bottom: 12px;"></i>
                    <h3>Total Orders</h3>
                    <p id="total-orders">0</p>
                </div>
                <div class="stat-card pixel-border">
                    <i class="fas fa-clock"
                        style="font-size: 1.5rem; color: var(--neon-orange); margin-bottom: 12px;"></i>
                    <h3>Pending</h3>
                    <p id="pending-orders">0</p>
                </div>
                <div class="stat-card pixel-border">
                    <h3 id="avg-order">$0</h3>
                    <p>Avg Order Value</p>
                </div>
                <div class="stat-card pixel-border">
                    <h3 id="conversion-rate">0%</h3>
                    <p>Fulfillment Rate</p>
                </div>
            </div>

            <div class="pixel-border" style="padding: 24px; margin-top: 24px;">
                <h3 style="font-family: 'Press Start 2P', monospace; font-size: 0.8rem; margin-bottom: 16px;">Top
                    Selling Products</h3>
                <div id="top-products"></div>
            </div>

            <div class="pixel-border" style="padding: 24px; margin-top: 24px;">
                <h3 style="font-family: 'Press Start 2P', monospace; font-size: 0.8rem; margin-bottom: 16px;">Order
                    Status Breakdown</h3>
                <div id="status-breakdown"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab-content">
            <h2 style="font-family: 'Press Start 2P', monospace; font-size: 1rem; margin-bottom: 24px;">Settings</h2>

            <div class="settings-section pixel-border" style="padding: 24px;">
                <h3>Shop Information</h3>
                <div class="product-form">
                    <input type="text" id="shop-name" placeholder="Shop Name" value="biy">
                    <input type="email" id="shop-email" placeholder="Contact Email" value="biyclothingstore@gmail.com">
                    <input type="text" id="shop-instagram" placeholder="Instagram Handle" value="@biyclothing">
                    <input type="text" id="shop-twitter" placeholder="Twitter Handle" value="@biyclothing">
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>

            <div class="settings-section pixel-border" style="padding: 24px;">
                <h3>Notifications</h3>
                <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <input type="checkbox" id="notify-orders" checked> Email me on new orders
                </label>
                <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <input type="checkbox" id="notify-lowstock" checked> Alert when stock is low (< 3 items) </label>
            </div>

            <div class="settings-section pixel-border" style="padding: 24px;">
                <h3>Danger Zone</h3>
                <button class="btn" style="background: #ffebee; border-color: #f44336;" onclick="clearAllOrders()">Clear
                    All Orders</button>
                <button class="btn" style="background: #ffebee; border-color: #f44336; margin-left: 12px;"
                    onclick="resetShop()">Reset Shop Data</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Navigation</h4>
                <a href="index.html">View Shop</a>
                <a href="admin.html">Dashboard</a>
            </div>
            <div class="footer-section">
                <h4>Social</h4>
                <div class="social-links">
                    <a href="https://instagram.com/biyclothing" target="_blank"><i class="fab fa-instagram"></i></a>
                    <a href="https://twitter.com/biyclothing" target="_blank"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">¬© 2024 biy Admin</div>
    </footer>

    <!-- Sidebar Navigation -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-nav">
            <a href="index.html" onclick="toggleSidebar()">Home</a>
            <a href="tees.html" onclick="toggleSidebar()">Tees</a>
            <a href="hoodies.html" onclick="toggleSidebar()">Outerwear</a>
            <a href="pants.html" onclick="toggleSidebar()">Jeans</a>
            <a href="footwear.html" onclick="toggleSidebar()">Footwear</a>
            <a href="accessories.html" onclick="toggleSidebar()">Accessories</a>
            <a href="contact.html" onclick="toggleSidebar()">Contact</a>
            <a href="admin.html" onclick="toggleSidebar()">Dashboard</a>
            <a href="#" onclick="logout(); toggleSidebar();">Logout</a>
        </div>
    </div>

    <!-- Categories Pop-up -->
    <div class="sidebar-overlay" id="category-overlay" onclick="toggleCategories()"></div>
    <div class="category-popup" id="category-popup">
        <h2
            style="font-family: 'Press Start 2P', monospace; font-size: 0.8rem; margin-bottom: 24px; text-align: center;">
            Categories</h2>
        <div class="category-grid">
            <a href="tees.html" class="category-item">Tees</a>
            <a href="hoodies.html" class="category-item">Outerwear</a>
            <a href="pants.html" class="category-item">Jeans</a>
            <a href="footwear.html" class="category-item">Footwear</a>
            <a href="accessories.html" class="category-item">Accessories</a>
            <a href="contact.html" class="category-item">Contact</a>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }

        function toggleCategories() {
            document.getElementById('category-popup').classList.toggle('open');
            document.getElementById('category-overlay').classList.toggle('open');
        }
        // Authentication
        function checkAuth() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            window.location.href = 'login.html';
        }

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelector(`.admin-tab[onclick="showTab('${tabName}')"]`)?.classList.add('active');
        }

        // Firebase Configuration (User needs to fill this)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "your-id",
            appId: "your-app-id"
        };

        // Initialize Firebase
        let db = null;
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        }

        async function loadData() {
            try {
                const response = await fetch('products.json');
                shopData = await response.json();
            } catch (e) {
                shopData = { shopSettings: { stockAvailable: true } };
            }

            if (db) {
                // Load orders from Firebase
                db.ref('orders').on('value', (snapshot) => {
                    const data = snapshot.val();
                    orders = data ? Object.values(data) : [];
                    renderAll();
                });
            } else {
                // Fallback to localStorage
                orders = JSON.parse(localStorage.getItem('orders')) || [];
                renderAll();
            }
        }

        function renderAll() {
            renderOverview();
            renderOrders();
            renderProducts();
            renderCustomers();
            renderAnalytics();
            checkAlerts();
            updateShopStatusDisplay();
        }

        function renderOverview() {
            const delivered = orders.filter(o => o.status === 'delivered').length;
            const pending = orders.filter(o => o.status === 'pending').length;
            const revenue = orders.reduce((sum, o) => sum + o.total, 0);
            const customers = [...new Set(orders.map(o => o.customer.email))].length;

            document.getElementById('total-orders').textContent = orders.length;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('total-revenue').textContent = '$' + revenue.toFixed(0);
            document.getElementById('total-customers').textContent = customers;
            document.getElementById('quick-orders').textContent = pending + ' pending';

            // Product count
            let productCount = 0;
            ['outerwear', 'tees', 'jeans', 'footwear', 'accessories'].forEach(cat => {
                if (shopData[cat]) productCount += shopData[cat].length;
            });
            productCount += customProducts.length;
            document.getElementById('quick-products').textContent = productCount + ' items';
        }

        function checkAlerts() {
            const alertsEl = document.getElementById('alerts');
            const lowStockEl = document.getElementById('low-stock-alerts');
            let alerts = [];
            let lowStock = [];

            // Check low stock
            ['outerwear', 'tees', 'jeans', 'footwear', 'accessories'].forEach(cat => {
                if (shopData[cat]) {
                    shopData[cat].forEach(p => {
                        if (p.stock <= 2) lowStock.push(p);
                    });
                }
            });

            if (lowStock.length > 0) {
                lowStockEl.innerHTML = `
          <div class="alert-box alert-warning">
            <strong>‚ö†Ô∏è Low Stock Alert</strong><br>
            ${lowStock.map(p => `${p.name} (${p.stock} left)`).join(', ')}
          </div>
        `;
            } else {
                lowStockEl.innerHTML = '';
            }

            // Pending orders alert
            const pending = orders.filter(o => o.status === 'pending').length;
            if (pending > 0) {
                alerts.push(`<div class="alert-box alert-warning"><strong>üì¶ ${pending} pending order(s)</strong> need attention</div>`);
            }

            alertsEl.innerHTML = alerts.join('');
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-body');
            const noOrders = document.getElementById('no-orders');

            if (orders.length === 0) {
                noOrders.style.display = 'block';
                return;
            }
            noOrders.style.display = 'none';

            const sorted = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = sorted.map((order, i) => `
        <tr>
          <td><strong>${order.orderNumber}</strong></td>
          <td>${new Date(order.date).toLocaleDateString()}</td>
          <td>${order.customer.firstName} ${order.customer.lastName}<br><small>${order.customer.email}</small></td>
          <td>${order.items.length} item(s)</td>
          <td><strong>$${order.total.toFixed(2)}</strong></td>
          <td><span class="status-badge status-${order.status}">${order.status}</span></td>
          <td>
            <select onchange="updateOrderStatus('${order.orderNumber}', this.value)">
              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
              <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
            </select>
          </td>
        </tr>
      `).join('');
        }

        function updateOrderStatus(orderNumber, status) {
            const orderIndex = orders.findIndex(o => o.orderNumber === orderNumber);
            if (orderIndex !== -1) {
                orders[orderIndex].status = status;

                if (db) {
                    // Update in Firebase (we search for the key)
                    db.ref('orders').orderByChild('orderNumber').equalTo(orderNumber).once('value', (snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            childSnapshot.ref.update({ status: status });
                        });
                    });
                } else {
                    localStorage.setItem('orders', JSON.stringify(orders));
                    renderAll();
                }
            }
        }

        function exportOrders() {
            if (orders.length === 0) {
                alert('No orders to export');
                return;
            }
            const headers = ['Order #', 'Date', 'Customer', 'Email', 'Items', 'Total', 'Status'];
            const rows = orders.map(o => [
                o.orderNumber,
                new Date(o.date).toLocaleDateString(),
                `${o.customer.firstName} ${o.customer.lastName}`,
                o.customer.email,
                o.items.length,
                '$' + o.total.toFixed(2),
                o.status
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function renderProducts() {
            const tbody = document.getElementById('stock-body');
            let allProducts = [];

            ['outerwear', 'tees', 'jeans', 'footwear', 'accessories'].forEach(cat => {
                if (shopData[cat]) allProducts = allProducts.concat(shopData[cat]);
            });
            allProducts = allProducts.concat(customProducts);

            tbody.innerHTML = allProducts.map(p => `
        <tr>
          <td><img src="${p.image}" style="width:50px;height:50px;object-fit:cover;" onerror="this.src='https://placehold.co/50x50/eee/999?text=?'"></td>
          <td>${p.name}</td>
          <td>${p.brand}</td>
          <td>${p.category}</td>
          <td>$${p.price.toFixed(2)}</td>
          <td><strong style="color: ${p.stock <= 2 ? '#f44336' : '#000'}">${p.stock || 0}</strong></td>
          <td>
            <button class="btn btn-small" onclick="editStock(${p.id})">Edit</button>
          </td>
        </tr>
      `).join('');
        }

        function showAddProduct() {
            document.getElementById('add-product-form').style.display = 'block';
        }
        function hideAddProduct() {
            document.getElementById('add-product-form').style.display = 'none';
        }

        function addProduct() {
            const product = {
                id: Date.now(),
                name: document.getElementById('new-name').value,
                brand: document.getElementById('new-brand').value,
                category: document.getElementById('new-category').value,
                price: parseFloat(document.getElementById('new-price').value),
                stock: parseInt(document.getElementById('new-stock').value),
                sizes: document.getElementById('new-sizes').value.split(',').map(s => s.trim()),
                image: document.getElementById('new-image').value || 'https://placehold.co/400x400/1a1a1a/fff?text=New'
            };

            customProducts.push(product);
            localStorage.setItem('customProducts', JSON.stringify(customProducts));
            hideAddProduct();
            renderAll();
            alert('Product added! Note: Custom products are stored in browser storage.');
        }

        function editStock(productId) {
            const newStock = prompt('Enter new stock quantity:');
            if (newStock !== null) {
                const stock = parseInt(newStock);
                // Check custom products first
                const custom = customProducts.find(p => p.id === productId);
                if (custom) {
                    custom.stock = stock;
                    localStorage.setItem('customProducts', JSON.stringify(customProducts));
                }
                renderAll();
                alert('Stock updated in browser. For permanent changes, edit products.json');
            }
        }

        function renderCustomers() {
            const tbody = document.getElementById('customers-body');
            const noCustomers = document.getElementById('no-customers');

            // Group orders by customer email
            const customerMap = {};
            orders.forEach(o => {
                const email = o.customer.email;
                if (!customerMap[email]) {
                    customerMap[email] = {
                        name: `${o.customer.firstName} ${o.customer.lastName}`,
                        email: email,
                        orders: 0,
                        total: 0,
                        lastOrder: o.date
                    };
                }
                customerMap[email].orders++;
                customerMap[email].total += o.total;
                if (new Date(o.date) > new Date(customerMap[email].lastOrder)) {
                    customerMap[email].lastOrder = o.date;
                }
            });

            const customers = Object.values(customerMap);
            if (customers.length === 0) {
                noCustomers.style.display = 'block';
                return;
            }
            noCustomers.style.display = 'none';

            tbody.innerHTML = customers.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>${c.email}</td>
          <td>${c.orders}</td>
          <td>$${c.total.toFixed(2)}</td>
          <td>${new Date(c.lastOrder).toLocaleDateString()}</td>
        </tr>
      `).join('');
        }

        function renderAnalytics() {
            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.date).toDateString() === today);
            const todayRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
            const avgOrder = orders.length > 0 ? orders.reduce((sum, o) => sum + o.total, 0) / orders.length : 0;
            const delivered = orders.filter(o => o.status === 'delivered').length;
            const fulfillmentRate = orders.length > 0 ? (delivered / orders.length * 100) : 0;

            document.getElementById('today-orders').textContent = todayOrders.length;
            document.getElementById('today-revenue').textContent = '$' + todayRevenue.toFixed(0);
            document.getElementById('avg-order').textContent = '$' + avgOrder.toFixed(0);
            document.getElementById('conversion-rate').textContent = fulfillmentRate.toFixed(0) + '%';

            // Status breakdown
            const statusCounts = { pending: 0, processing: 0, shipped: 0, delivered: 0 };
            orders.forEach(o => statusCounts[o.status] = (statusCounts[o.status] || 0) + 1);
            document.getElementById('status-breakdown').innerHTML = `
        <div style="display:flex;gap:24px;flex-wrap:wrap;">
          <div><span class="status-badge status-pending">Pending</span> ${statusCounts.pending}</div>
          <div><span class="status-badge status-processing">Processing</span> ${statusCounts.processing}</div>
          <div><span class="status-badge status-shipped">Shipped</span> ${statusCounts.shipped}</div>
          <div><span class="status-badge status-delivered">Delivered</span> ${statusCounts.delivered}</div>
        </div>
      `;

            // Top products (from orders)
            const productCounts = {};
            orders.forEach(o => {
                o.items.forEach(item => {
                    const key = item.name;
                    productCounts[key] = (productCounts[key] || 0) + item.quantity;
                });
            });
            const topProducts = Object.entries(productCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            document.getElementById('top-products').innerHTML = topProducts.length > 0
                ? topProducts.map(([name, count]) => `<div style="padding:8px 0;border-bottom:1px solid #eee;">${name} <strong>(${count} sold)</strong></div>`).join('')
                : '<p style="opacity:0.7;">No sales data yet</p>';
        }

        function updateShopStatusDisplay() {
            const statusEl = document.getElementById('shop-status');
            const btnEl = document.getElementById('toggle-shop');
            const isOpen = shopData?.shopSettings?.stockAvailable !== false;

            statusEl.innerHTML = isOpen
                ? '<span style="color: #2e7d32; font-weight: bold;">üü¢ OPEN</span>'
                : '<span style="color: #c62828; font-weight: bold;">üî¥ CLOSED</span>';
            btnEl.textContent = isOpen ? 'Close Shop' : 'Open Shop';
        }

        function toggleShopStatus() {
            if (!shopData.shopSettings) shopData.shopSettings = {};
            shopData.shopSettings.stockAvailable = !shopData.shopSettings.stockAvailable;
            localStorage.setItem('shopStatus', shopData.shopSettings.stockAvailable ? 'open' : 'closed');
            updateShopStatusDisplay();
            alert('Shop status updated! Edit products.json for permanent changes.');
        }

        function saveSettings() {
            const settings = {
                name: document.getElementById('shop-name').value,
                email: document.getElementById('shop-email').value,
                instagram: document.getElementById('shop-instagram').value,
                twitter: document.getElementById('shop-twitter').value
            };
            localStorage.setItem('shopSettings', JSON.stringify(settings));
            alert('Settings saved!');
        }

        function clearAllOrders() {
            if (confirm('Are you sure? This will delete ALL orders permanently.')) {
                localStorage.removeItem('orders');
                orders = [];
                renderAll();
            }
        }

        function resetShop() {
            if (confirm('Are you sure? This will reset ALL shop data including orders and custom products.')) {
                localStorage.removeItem('orders');
                localStorage.removeItem('customProducts');
                localStorage.removeItem('shopSettings');
                location.reload();
            }
        }

        // Initialize
        if (checkAuth()) {
            loadData();

            // Load saved settings
            const savedSettings = JSON.parse(localStorage.getItem('shopSettings') || '{}');
            if (savedSettings.name) document.getElementById('shop-name').value = savedSettings.name;
            if (savedSettings.email) document.getElementById('shop-email').value = savedSettings.email;
            if (savedSettings.instagram) document.getElementById('shop-instagram').value = savedSettings.instagram;
            if (savedSettings.twitter) document.getElementById('shop-twitter').value = savedSettings.twitter;
        }
    </script>
</body>

</html>